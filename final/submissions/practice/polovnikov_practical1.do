set more off
clear all
// set environment variables
global projects: env projects
global storage : env storage

*ssc install ivreg2
*ssc install xtivreg2

global data = "$storage/econ900/econ900-03/final"
global code = "$projects/econ900-03_empirical/classcodes"

cd  $data
use lottery_oldstata.dta, clear

////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////Question 1////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

ivreg2 lnw female (d=z), first
*or
reg d z 
*both perform the F-test on instrument relevance

////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////Question 2////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

egen lot_year_fem = group(lotcateg year female)
* I use this clustering, b/c it allows standard errors to be correlated for lot_category-year-gender group
* it also gives 'sufficient' number of clusters 
ivreg2 lnw female (d=z), cluster(lot_year_fem) 

////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////Question 3////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

* IV and 2sls equivalence
ivreg2 lnw female (d=z)
quietly reg d z female
predict d_hat
reg lnw d_hat female 
drop d_hat

////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////Question 4////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

//reduced form
egen E_y_i1 = mean(lnw) if z == 1
egen rf_1 = max(E_y_i1) 
drop E_y_i1
egen E_y_i0 = mean(lnw) if z == 0
egen rf_0 = max(E_y_i0) 
drop E_y_i0
//first stage
egen D_i1 = mean(d) if z == 1
egen fs_1 = max(D_i1) 
drop D_i1
egen D_i0 = mean(d) if z == 0
egen fs_0 = max(D_i0) 
drop D_i0
//quotient (Wald)
di "Wald estimator = "(rf_1 - rf_0)/(fs_1 - fs_0) ", which is equivalent to IV regression"
